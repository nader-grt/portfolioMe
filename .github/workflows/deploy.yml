
name: Push To EC2

on:
  push:
    branches:
      - main

jobs:
  deploy-react:
    name: ğŸš€ React Production Deployment
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§¾ Checkout Code
        uses: actions/checkout@v3

      - name: ğŸ“¤ Deploy build folder to EC2 using ssh-deploy
        uses: easingthemes/ssh-deploy@v2.1.5
        env:
          SSH_PRIVATE_KEY: ${{ secrets.EC2_KEY }}       
          REMOTE_HOST: ${{ secrets.EC2_HOST }}
          REMOTE_USER: ${{ secrets.EC2_USER  }}

      - name: ğŸ› ï¸ Build React App
        run: |
          npm ci
          CI=false npm run build
      - name: ğŸ“¤ Upload build folder to EC2 temp path
        run: |
           rsync -avz -e "ssh -o StrictHostKeyChecking=no" ./ root@${{ secrets.EC2_HOST }}:/root/portfolioMe
      - name: ğŸš€ Move build to /var/www/portfolioMe and reload NGINX
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            set -e
            echo "Moving build to /var/www/portfolioMe..."
            sudo rm -rf /var/www/portfolioMe/*
            sudo cp -r /home/${USER}/react-build/* /var/www/portfolioMe/
            sudo chmod -R 755 /var/www/portfolioMe
            echo "Reloading NGINX..."
            sudo systemctl reload nginx
            echo "React deployment completed!"
          EOF

